<!doctype html>
<html lang="ms" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Enterprise ğŸ“š PPD Kota Marudu</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">

  <style>
    * { font-family: 'Plus Jakarta Sans', sans-serif; }
    html, body { height: 100%; margin: 0; }
.heat-card {
  transition: all 0.35s ease;
  border: 2px solid transparent;
}

.heat-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}
.checklist {
  list-style: none;
  padding: 0;
  margin: 0;
}

.checklist li {
  padding: 8px 10px;
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  gap: 10px;
  align-items: center;
  font-size: 13px;
}

.checklist li:hover {
  background: #f8fafc;
}

.checklist input {
  width: 16px;
  height: 16px;
}


    @keyframes fadeUp { from { opacity: 0; transform: translateY(18px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes pulse-light { 0%, 100% { box-shadow: 0 4px 20px rgba(11, 42, 91, 0.08); } 50% { box-shadow: 0 8px 32px rgba(11, 42, 91, 0.12); } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .anim-fade-up { animation: fadeUp 0.6s ease-out both; }
    .anim-slide-right { animation: slideInRight 0.6s ease-out both; }
    .shadow-pulse { animation: pulse-light 2s ease-in-out infinite; }

    body.dark-mode { background: #0f1419 !important; color: #e2e8f0; }
    body.dark-mode #app-wrapper { background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 50%, #1a2535 100%) !important; }
    body.dark-mode .card-base { background: #1a1f2e; border-color: #2d3748; }

    .card-base {
      border-radius: 16px;
      padding: 24px;
      border: 1px solid #e8edf5;
      background: #fff;
      transition: all 0.25s ease;
      box-shadow: 0 4px 16px rgba(11, 42, 91, 0.08);
    }
    .card-base:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(11, 42, 91, 0.12); }

    .stat-kpi {
      background: linear-gradient(135deg, #0b2a5b, #1e4fa3);
      color: #fff;
      padding: 20px;
      border-radius: 14px;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }
    .stat-kpi::before { content: ''; position: absolute; top: -50%; right: -50%; width: 200px; height: 200px; border-radius: 50%; background: rgba(255, 255, 255, 0.05); }
    .stat-kpi:hover { transform: translateY(-4px); }

    .critical-alert {
      background: #fef2f2;
      border: 2px solid #dc2626;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      animation: slideDown 0.4s ease-out;
    }

    .critical-alert p { color: #dc2626; margin: 0; font-weight: 600; font-size: 13px; }

    .grid-3col { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }

    .rank-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .rank-table thead { background: linear-gradient(135deg, #0b2a5b, #1e4fa3); color: #fff; }
    .rank-table th { padding: 12px; font-weight: 700; text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
    .rank-table td { padding: 12px; border-bottom: 1px solid #e8edf5; }
    .rank-table tr:hover { background: rgba(11, 42, 91, 0.04); }

    .search-box {
      position: relative;
      flex: 1;
      min-width: 200px;
    }

    .search-box input {
      width: 100%;
      padding: 10px 14px 10px 38px;
      border-radius: 10px;
      border: 1.5px solid #cbd5e1;
      font-size: 13px;
    }

    .search-box svg {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #e8edf5;
      border-radius: 10px;
      margin-top: 6px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 30;
      box-shadow: 0 8px 24px rgba(11, 42, 91, 0.1);
      display: none;
    }

    .search-results.show { display: block; }

    .search-result-item {
      padding: 10px 14px;
      border-bottom: 1px solid #f1f5f9;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }

    .search-result-item:hover { background: #f8fafc; }

    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(11, 42, 91, 0.5);
      backdrop-filter: blur(6px);
      z-index: 50;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .modal-overlay.show { opacity: 1; pointer-events: all; }

    .modal-content {
      border-radius: 20px; padding: 32px;
      max-width: 600px; width: 90%;
      background: #fff;
      transform: scale(0.9);
      transition: transform 0.3s ease;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(11, 42, 91, 0.15);
    }
    .modal-overlay.show .modal-content { transform: scale(1); }

    .toast-msg {
      position: fixed; bottom: 24px; right: 24px;
      padding: 14px 24px; border-radius: 12px;
      font-weight: 600; font-size: 14px; z-index: 60;
      transform: translateY(80px); opacity: 0;
      transition: all 0.4s ease;
      box-shadow: 0 8px 24px rgba(11, 42, 91, 0.15);
    }
    .toast-msg.show { transform: translateY(0); opacity: 1; }

    .tab-btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.25s ease;
      cursor: pointer;
      border: none;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 6px;
      color: #0b2a5b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1.5px solid #cbd5e1;
      font-size: 13px;
      font-family: inherit;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #1e4fa3;
      box-shadow: 0 0 0 3px rgba(30, 79, 163, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      justify-content: flex-end;
    }

    .btn-primary {
      background: linear-gradient(135deg, #0b2a5b, #1e4fa3);
      color: #fff;
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(11, 42, 91, 0.2); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-secondary {
      background: #f1f5f9;
      color: #0b2a5b;
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover { background: #e2e8f0; }

    .edit-btn {
      background: #1e4fa3;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .edit-btn:hover { background: #0b2a5b; }

    .capacity-card {
      padding: 16px;
      border-radius: 12px;
      background: #f8fafc;
      border: 1.5px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .capacity-card:hover { background: #f1f5f9; transform: translateY(-2px); }

    .capacity-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
    }

    .capacity-fill {
      height: 100%;
      border-radius: 4px;
      transition: all 0.4s ease;
    }

    @media print {
      .no-print { display: none !important; }
      body { background: #fff; }
      #app-wrapper { background: #fff !important; }
      main { max-width: 100%; padding: 20px !important; }
      .card-base { box-shadow: none; border: 1px solid #cbd5e1; page-break-inside: avoid; }
    }
/* =========================
   MOBILE ENTERPRISE FINAL
   (SATU SAHAJA RULE)
========================= */
@media (max-width:768px){

  /* ===== HEADER ===== */
  header{
    padding:12px 10px !important;
  }

  header h1{
    font-size:16px !important;
    line-height:1.3;
  }

  header p{
    font-size:10px !important;
  }

  header img{
    width:36px !important;
    height:36px !important;
  }

  header > div > div{
    flex-wrap:wrap !important;
  }

  /* ===== SEARCH ===== */
  .search-box{
    width:100% !important;
    min-width:unset !important;
  }

  /* ===== TAB NAV ===== */
  nav{
    overflow-x:auto;
    display:flex;
    gap:6px;
    -webkit-overflow-scrolling:touch;
  }

  .tab-btn{
    flex:0 0 auto !important;
    padding:8px 12px !important;
    font-size:12px !important;
    white-space:nowrap;
  }

  /* ===== KPI ===== */
  .grid-3col{
    grid-template-columns:1fr !important;
    gap:10px !important;
  }

  .stat-kpi p:last-child{
    font-size:24px !important;
  }

  /* ===== DASHBOARD GRID ===== */
  section > div[style*="grid-template-columns"]{
    display:grid !important;
    grid-template-columns:1fr !important;
  }

  /* ===== CHART ===== */
  .chart-container{
    width:100% !important;
    height:220px !important;
    margin-bottom:12px !important;
  }

  .chart-container canvas{
    width:100% !important;
    height:100% !important;
  }

  /* ===== SENARAI â†’ CARD MODE ===== */
  #tab-senarai .rank-table,
  #tab-senarai .rank-table thead,
  #tab-senarai .rank-table tbody,
  #tab-senarai .rank-table th,
  #tab-senarai .rank-table td,
  #tab-senarai .rank-table tr{
    display:block;
    width:100%;
  }

  #tab-senarai .rank-table thead{
    display:none;
  }

  #tab-senarai .rank-table tr{
    background:#fff;
    border:1px solid #e2e8f0;
    border-radius:12px;
    padding:12px;
    margin-bottom:10px;
    box-shadow:0 2px 10px rgba(0,0,0,0.05);
  }

  #tab-senarai .rank-table td{
    border:none !important;
    padding:6px 0 !important;
    font-size:12px !important;
    display:flex;
    justify-content:space-between;
  }

  #tab-senarai .rank-table td::before{
    font-weight:700;
    color:#0b2a5b;
  }

  #tab-senarai .rank-table td:nth-child(1)::before{content:"Nama";}
  #tab-senarai .rank-table td:nth-child(2)::before{content:"Asal";}
  #tab-senarai .rank-table td:nth-child(3)::before{content:"Baharu";}
  #tab-senarai .rank-table td:nth-child(4)::before{content:"Tingkatan";}
  #tab-senarai .rank-table td:nth-child(5)::before{content:"Kategori";}
  #tab-senarai .rank-table td:nth-child(6)::before{content:"Tarikh";}
  #tab-senarai .rank-table td:nth-child(7)::before{content:"Status";}
  #tab-senarai .rank-table td:nth-child(8)::before{content:"Tindakan";}

  /* ===== RANKING MOBILE CARD MODE ===== */
@media (max-width:768px){

  #ranking-container > div{
    display:block !important;
  }

  #tab-ranking .rank-table,
  #tab-ranking .rank-table thead,
  #tab-ranking .rank-table tbody,
  #tab-ranking .rank-table th,
  #tab-ranking .rank-table td,
  #tab-ranking .rank-table tr{
    display:block;
    width:100%;
  }

  #tab-ranking .rank-table thead{
    display:none;
  }

  #tab-ranking .rank-table tr{
    background:#fff;
    border:1px solid #e2e8f0;
    border-radius:12px;
    padding:12px;
    margin-bottom:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.05);
  }

  #tab-ranking .rank-table td{
    border:none !important;
    display:flex;
    justify-content:space-between;
    padding:5px 0 !important;
    font-size:12px !important;
  }

  #tab-ranking .rank-table td::before{
    font-weight:700;
    color:#0b2a5b;
  }

  #tab-ranking .rank-table td:nth-child(1)::before{content:"#";}
  #tab-ranking .rank-table td:nth-child(2)::before{content:"Sekolah";}
  #tab-ranking .rank-table td:nth-child(3)::before{content:"Bilangan";}
}


  /* ===== MODAL ===== */
  .modal-content{
    width:95% !important;
    padding:16px !important;
    border-radius:12px !important;
    max-height:90vh !important;
  }

  /* ===== QUICK ACTION ===== */
  #quick-actions{
    right:14px !important;
    bottom:14px !important;
  }

  main{
    padding-bottom:90px !important;
  }

  #dark-mode-toggle{
    bottom:10px !important;
    left:10px !important;
    width:42px !important;
    height:42px !important;
  }
}
/* =========================
   MOBILE PERFORMANCE FIX
========================= */
@media (max-width:768px){

  .heat-card:hover,
  .card-base:hover,
  .stat-kpi:hover{
    transform: none !important;
    box-shadow: inherit !important;
  }

  /* elak browser simpan layer animation */
  .heat-card,
  .card-base,
  .stat-kpi{
    transition: none !important;
    will-change: auto !important;
  }
}


  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full" style="background: #f4f7fb;">

<!-- â­ QUICK ACTIONS (BETUL DI SINI) -->
<div id="quick-actions" class="no-print"
style="
position: fixed;
bottom: 24px;
right: 24px;
z-index: 45;
display:flex;
flex-direction:column;
gap:10px;">

 <button onclick="openAddModal()" class="btn-primary">â•</button>
<button onclick="exportExcel()" class="btn-primary">ğŸ“Š</button>
<button onclick="exportPDFKPM()" class="btn-primary">ğŸ“„</button>

<button onclick="logoutSystem()"
        class="btn-primary"
        style="background:#dc2626;">
  ğŸšª
</button>



</div>

<!-- APP WRAPPER -->
  <div id="app-wrapper" class="h-full w-full" style="background: linear-gradient(135deg, #f4f7fb 0%, #e9f0f8 50%, #e0ecf5 100%); overflow-y: auto; overflow-x: hidden;"><!-- Dark Mode Toggle --> <button id="dark-mode-toggle" class="no-print" onclick="toggleDarkMode()" style="position: fixed; bottom: 24px; left: 24px; z-index: 45; width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #0b2a5b, #1e4fa3); color: #fff; border: none; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(11, 42, 91, 0.15); transition: all 0.3s ease;" title="Dark Mode">ğŸŒ™</button> <!-- Header -->
   <header class="no-print shadow-pulse" style="background: linear-gradient(135deg, #0b2a5b 0%, #1e4fa3 60%, #2d5fa8 100%); padding: 24px 32px; position: sticky; top: 0; z-index: 40; border-bottom: 1px solid rgba(255,255,255,0.1);">
    <div style="max-width: 1600px; margin: 0 auto;">
     <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; margin-bottom: 16px;">
      <div style="display: flex; align-items: center; gap: 16px; flex: 1; min-width: 200px;">
      <div style="
  width:56px;
  height:56px;
  border-radius:14px;
  background:rgba(255,255,255,0.18);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
">
  <img src="https://i.imgur.com/4EGUuTx.png"
       style="
         width:46px;
         height:46px;
         object-fit:contain;
         image-rendering:auto;
       ">
</div>


       <div>
        <h1 style="color: #fff; font-size: 22px; font-weight: 800; line-height: 1.2; margin: 0;">Dashboard Pertukaran Murid</h1>
        <p style="color: rgba(255,255,255,0.85); font-size: 11px; font-weight: 500; margin: 2px 0 0 0;">Kementerian Pendidikan Malaysia</p>
<p id="user-display"
   style="color:#fff;font-size:12px;font-weight:600;opacity:0.9;margin-top:4px;">
</p>

       </div>
      </div>
      <div class="search-box no-print" style="flex: 0 1 250px;">
       <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35" />
       </svg><input id="search-input" type="text" placeholder="Cari nama pelajar..." onkeyup="handleSearch()">
       <div id="search-results" class="search-results"></div>
      </div>
     <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">

  <button class="tab-btn" 
    style="background: linear-gradient(135deg, #10b981, #059669); color: #fff; display: flex; align-items: center; gap: 6px; font-weight: 700;"
    onclick="openAddModal()">
    <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
    Tambah
  </button>

  <button class="tab-btn"
    style="background: rgba(255,255,255,0.18); color: #fff; display: flex; align-items: center; gap: 6px;"
    onclick="exportExcel()">
    <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V12" />
    </svg>
    Excel
  </button>

  <button class="tab-btn"
    style="background: rgba(255,255,255,0.18); color: #fff; display: flex; align-items: center; gap: 6px;"
    onclick="exportPDFKPM()">
    <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
    </svg>
    PDF KPM
  </button>

  <!-- ğŸ” ADMIN LOGIN -->
  <button class="tab-btn"
    style="background:#dc2626;color:#fff;"
    onclick="showAdminLogin()">
    ğŸ” Admin Login
  </button>

</div>

   </header>
   <main style="max-width: 1600px; margin: 0 auto; padding: 24px 20px 40px;"><!-- Critical Alerts -->
    <div id="critical-alerts" style="margin-bottom: 24px;"></div><!-- Tabs -->
    <nav class="no-print anim-fade-up" style="display: flex; gap: 6px; margin-bottom: 24px; background: #fff; border-radius: 14px; padding: 6px; border: 1px solid #e8edf5; box-shadow: 0 4px 16px rgba(11, 42, 91, 0.08);"><button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')" style="background: linear-gradient(135deg, #0b2a5b, #1e4fa3); flex: 1; color: #fff;">ğŸ“Š Dashboard</button> <button class="tab-btn" data-tab="senarai" onclick="switchTab('senarai')" style="flex: 1;">ğŸ“‹ Senarai</button> <button class="tab-btn" data-tab="ranking" onclick="switchTab('ranking')" style="flex: 1;">ğŸ† Ranking</button> <button class="tab-btn" data-tab="capacity" onclick="switchTab('capacity')" style="flex: 1;">ğŸ¢ Kepadatan</button>
<button class="tab-btn" data-tab="semak" onclick="switchTab('semak')" style="flex: 1;">
  ğŸ“‘ Senarai Semak
</button>

    </nav><!-- DASHBOARD TAB -->
    <section id="tab-dashboard" role="tabpanel">
     <div class="grid-3col anim-fade-up" style="animation-delay: 0.05s; margin-bottom: 24px;">

  <!-- JUMLAH -->
  <div class="stat-kpi">
    <p style="opacity:.9;font-size:12px;margin:0 0 6px 0;font-weight:600;">
      JUMLAH PERMOHONAN
    </p>
    <p id="kpi-total" style="font-size:32px;font-weight:800;margin:0;">0</p>
  </div>

  <!-- DILULUSKAN -->
  <div class="stat-kpi" style="background:linear-gradient(135deg,#059669,#10b981);">
    <p style="opacity:.9;font-size:12px;margin:0 0 6px 0;font-weight:600;">
      DILULUSKAN
    </p>
    <p id="kpi-approved" style="font-size:32px;font-weight:800;margin:0;">0</p>
  </div>

  <!-- DALAM PROSES -->
  <div class="stat-kpi" style="background:linear-gradient(135deg,#d97706,#f59e0b);">
    <p style="opacity:.9;font-size:12px;margin:0 0 6px 0;font-weight:600;">
      DALAM PROSES
    </p>
    <p id="kpi-pending" style="font-size:32px;font-weight:800;margin:0;">0</p>
  </div>

  <!-- DITOLAK (BARU) -->
  <div class="stat-kpi" style="background:linear-gradient(135deg,#dc2626,#ef4444);">
    <p style="opacity:.9;font-size:12px;margin:0 0 6px 0;font-weight:600;">
      DITOLAK
    </p>
    <p id="kpi-rejected" style="font-size:32px;font-weight:800;margin:0;">0</p>
  </div>

</div>

     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
      <div class="card-base anim-fade-up" style="animation-delay: 0.1s;">
       <h3 style="font-size: 14px; font-weight: 700; color: #0b2a5b; margin: 0 0 16px 0;">ğŸ“Š Distribusi Status</h3>
       <div class="chart-container">
        <canvas id="donut-chart"></canvas>
       </div>
      </div>
      <div class="card-base anim-slide-right" style="animation-delay: 0.1s;">
       <h3 style="font-size: 14px; font-weight: 700; color: #0b2a5b; margin: 0 0 16px 0;">ğŸ“ˆ Permohonan Bulanan</h3>
       <div class="chart-container">
        <canvas id="monthly-chart"></canvas>
       </div>
      </div>
     </div>
     <div class="card-base anim-fade-up" style="animation-delay: 0.12s;">
      <h3 style="font-size: 14px; font-weight: 700; color: #0b2a5b; margin: 0 0 16px 0;">ğŸ”„ Perbandingan Kategori Pertukaran</h3>
      <div class="chart-container">
       <canvas id="category-chart"></canvas>
      </div>
     </div>
     <div class="card-base anim-fade-up" style="animation-delay: 0.15s;">
      <h3 style="font-size: 14px; font-weight: 700; color: #0b2a5b; margin: 0 0 16px 0;">ğŸ§  AI Insight</h3>
      <div id="ai-insights" style="display: grid; gap: 12px;"></div>
     </div>
    </section><!-- SENARAI TAB -->
    <section id="tab-senarai" style="display: none;" role="tabpanel">
     <div class="card-base anim-fade-up">
      <div style="margin-bottom: 16px;">
       <h2 style="font-size: 16px; font-weight: 700; color: #0b2a5b; margin: 0 0 12px 0;">ğŸ“‹ Senarai Permohonan</h2><select id="list-filter-status" onchange="renderList()" class="filter-select" style="padding: 8px 14px; border-radius: 10px; border: 1.5px solid #cbd5e1; font-size: 13px;"> <option value="all">Semua Status</option> <option value="Dalam Proses">Dalam Proses</option> <option value="Diluluskan">Diluluskan</option> <option value="Ditolak">Ditolak</option> </select>
      </div>
      <div id="list-container"
     style="
       max-height: 500px;
       overflow-y: auto;
       overflow-x: hidden;
       -webkit-overflow-scrolling: touch;
     ">
</div>


      <div id="list-empty" style="text-align: center; padding: 50px 20px; display: none;">
       <p style="font-size: 40px; margin-bottom: 10px;">ğŸ“‹</p>
       <p style="font-size: 14px; color: #94a3b8;">Tiada Permohonan</p>
      </div>
     </div>
    </section><!-- RANKING TAB -->
    <section id="tab-ranking" style="display: none;" role="tabpanel">
  <div class="card-base anim-fade-up">
    <h2 style="font-size: 16px; font-weight: 700; color: #0b2a5b; margin: 0 0 16px 0;">
      ğŸ† Ranking Pertukaran
    </h2>

    <!-- âœ… GRAF PERBANDINGAN -->
    <div class="chart-container" style="height:320px;margin-bottom:16px;">
      <canvas id="ranking-compare-chart"></canvas>
    </div>

    <!-- Jadual asal -->
    <div id="ranking-container" style="min-height: 300px;"></div>
  </div>
</section>

<!-- CAPACITY TAB -->
    <section id="tab-capacity" style="display: none;" role="tabpanel">
     <div class="card-base anim-fade-up">
      <h2 style="font-size: 16px; font-weight: 700; color: #0b2a5b; margin: 0 0 20px 0;">ğŸ¢ Analisis Kepadatan Sekolah</h2>
      <div id="capacity-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; min-height: 400px;"></div>
     </div>
    </section>
<!-- SENARAI SEMAK TAB -->
<section id="tab-semak" style="display: none;" role="tabpanel">

  <div class="card-base anim-fade-up">

    <h2 style="font-size:16px;font-weight:700;color:#0b2a5b;margin-bottom:16px;">
      ğŸ“‘ Senarai Semak Dokumen Pertukaran
    </h2>

    <div style="display:grid;gap:20px;">

      <!-- ========================= -->
      <!-- MENENGAH -->
      <!-- ========================= -->
      <div>
        <h3 style="font-size:14px;font-weight:700;color:#1e4fa3;margin-bottom:10px;">
          ğŸ“ Pertukaran Menengah
        </h3>

        <ul class="checklist">
          <li><input type="checkbox"> Borang P.U (A) 275@jadual Ketiga</li>
          <li><input type="checkbox"> Salinan Sijil Lahir</li>
          <li><input type="checkbox"> Salinan Kad Pengenalan Murid</li>
          <li><input type="checkbox"> Kad Pengenalan Ibu Bapa / Penjaga</li>
          <li><input type="checkbox"> Surat Hak Penjagaan (jika bercerai)</li>
          <li><input type="checkbox"> Surat Nikah / Perkahwinan</li>
          <li><input type="checkbox"> Sijil Kematian (jika berkaitan)</li>
          <li><input type="checkbox"> Bil Air / Elektrik</li>
          <li><input type="checkbox"> Surat Anak Angkat</li>
          <li><input type="checkbox"> Keputusan Peperiksaan</li>
        </ul>
      </div>

      <!-- ========================= -->
      <!-- SWASTA / CICIR -->
      <!-- ========================= -->
      <div>
        <h3 style="font-size:14px;font-weight:700;color:#1e4fa3;margin-bottom:10px;">
          ğŸ« Swasta / Cicir / Lewat
        </h3>

        <ul class="checklist">
          <li><input type="checkbox"> Borang ASBS</li>
          <li><input type="checkbox"> Salinan Sijil Lahir</li>
          <li><input type="checkbox"> Salinan Kad Pengenalan Murid</li>
          <li><input type="checkbox"> Kad Pengenalan Ibu Bapa</li>
          <li><input type="checkbox"> Surat Hak Penjagaan</li>
          <li><input type="checkbox"> Surat Nikah</li>
          <li><input type="checkbox"> Sijil Kematian</li>
          <li><input type="checkbox"> Bil Air / Elektrik</li>
          <li><input type="checkbox"> Surat Anak Angkat</li>
          <li><input type="checkbox"> Keputusan Peperiksaan</li>
          <li><input type="checkbox"> Sijil Berhenti Sekolah</li>
        </ul>
      </div>

      <!-- ========================= -->
      <!-- TANPA SIJIL LAHIR -->
      <!-- ========================= -->
      <div>
        <h3 style="font-size:14px;font-weight:700;color:#1e4fa3;margin-bottom:10px;">
          âš ï¸ Tanpa Sijil Lahir
        </h3>

        <ul class="checklist">
          <li><input type="checkbox"> Borang MWTD/SPI.1/2009</li>
          <li><input type="checkbox"> Permohonan lewat kelahiran (JPN)</li>
          <li><input type="checkbox"> Pengesahan kelahiran (klinik/hospital)</li>
          <li><input type="checkbox"> Salinan IC ibu bapa / penjaga</li>
        </ul>
      </div>

      <!-- NOTE -->
      <div style="background:#fef9c3;padding:12px;border-radius:10px;font-size:12px;">
        âš ï¸ Keputusan bergantung kepada kekosongan sekolah dan keputusan adalah muktamad.
      </div>

    </div>

  </div>
</section>

   </main>
   <footer class="no-print" style="text-align: center; padding: 20px; color: #94a3b8; font-size: 12px; border-top: 1px solid #e8edf5; margin-top: 40px;">
    Â© 2024 Kementerian Pendidikan Malaysia â€” Dashboard Enterprise Pertukaran Murid
   </footer>
  </div><!-- Add Modal -->
  <div id="add-modal" class="modal-overlay" onclick="closeAddModal(event)">
   <div class="modal-content" onclick="event.stopPropagation()">
    <h2 style="font-size: 20px; font-weight: 800; color: #0b2a5b; margin: 0 0 24px 0;">â• Tambah Permohonan Baru</h2>
    <form id="add-form" onsubmit="handleAddSubmit(event)">
     <div class="form-group"><label for="student_name">Nama Pelajar *</label> <input type="text" id="student_name" name="student_name" required placeholder="Masukkan nama pelajar">
     </div>
     <div class="form-group"><label for="school_from">Sekolah Asal *</label> <select id="school_from" name="school_from" required onchange="toggleCustomSchoolFrom()"> <option value="">-- Pilih Sekolah --</option> <option value="SMK Kota Marudu">SMK Kota Marudu</option> <option value="SMK Tandek">SMK Tandek</option> <option value="SMK Tandek 2">SMK Tandek 2</option> <option value="SMK Langkon">SMK Langkon</option> <option value="SMK Bengkongan">SMK Bengkongan</option> <option value="SMK Salaping">SMK Salaping</option> <option value="SMK Bandau">SMK Bandau</option> <option value="K9 Mangandai">K9 Mangandai</option> <option value="Sekolah Lain">Sekolah Lain</option> </select>
     </div>
     <div id="custom_school_from_group" class="form-group" style="display: none;"><label for="custom_school_from">Nama Sekolah Asal *</label> <input type="text" id="custom_school_from" name="custom_school_from" placeholder="Masukkan nama sekolah">
     </div>
     <div class="form-group"><label for="school_to">Sekolah Baharu *</label> <select id="school_to" name="school_to" required onchange="toggleCustomSchoolTo()"> <option value="">-- Pilih Sekolah --</option> <option value="SMK Kota Marudu">SMK Kota Marudu</option> <option value="SMK Tandek">SMK Tandek</option> <option value="SMK Tandek 2">SMK Tandek 2</option> <option value="SMK Langkon">SMK Langkon</option> <option value="SMK Bengkongan">SMK Bengkongan</option> <option value="SMK Salaping">SMK Salaping</option> <option value="SMK Bandau">SMK Bandau</option> <option value="K9 Mangandai">K9 Mangandai</option> <option value="Sekolah Lain">Sekolah Lain</option> </select>
     </div>
     <div id="custom_school_to_group" class="form-group" style="display: none;"><label for="custom_school_to">Nama Sekolah Baharu *</label> <input type="text" id="custom_school_to" name="custom_school_to" placeholder="Masukkan nama sekolah">
     </div>
     <div class="form-group"><label for="grade">Tingkatan *</label> <select id="grade" name="grade" required> <option value="">-- Pilih Tingkatan --</option> <option value="Tingkatan 1">Tingkatan 1</option> <option value="Tingkatan 2">Tingkatan 2</option> <option value="Tingkatan 3">Tingkatan 3</option> <option value="Tingkatan 4">Tingkatan 4</option> <option value="Tingkatan 5">Tingkatan 5</option> <option value="Tingkatan 6">Tingkatan 6</option> </select>
     </div>
     <div class="form-group"><label for="transfer_category">Kategori Pertukaran *</label> <select id="transfer_category" name="transfer_category" required> <option value="">-- Pilih Kategori --</option> <option value="Dalam Daerah">Dalam Daerah</option> <option value="Antara Daerah">Antara Daerah</option> <option value="Antara Negeri">Antara Negeri</option> <option value="Rayuan Khas">Rayuan Khas</option> <option value="Aliran/Program">Aliran/Program</option> <option value="Belajar Semula/Cicir">Belajar Semula/Cicir</option> <option value="Sekolah Swasta">Sekolah Swasta</option> <option value="Murid Bukan Warganegara">Murid Bukan Warganegara</option> <option value="Murid Warganegara Tanpa Dokumen">Murid Warganegara Tanpa Dokumen</option> </select>
     </div>
     <div class="form-group"><label for="status">Status *</label> <select id="status" name="status" required> <option value="">-- Pilih Status --</option> <option value="Dalam Proses">Dalam Proses</option> <option value="Diluluskan">Diluluskan</option> <option value="Ditolak">Ditolak</option> </select>
     </div>
     <div class="form-group"><label for="date_applied">Tarikh Permohonan *</label> <input type="date" id="date_applied" name="date_applied" required>
     </div>
<div class="form-group">
  <label for="phone">No Telefon Ibu Bapa *</label>
  <input type="text" id="phone" name="phone" required placeholder="Contoh: 601156405871">
</div>
     <div class="form-group"><label for="notes">Catatan</label> <textarea id="notes" name="notes" placeholder="Masukkan catatan tambahan..."></textarea>
     </div>
     <div class="modal-actions"><button type="button" class="btn-secondary" onclick="closeAddModal()">Batal</button> <button type="submit" class="btn-primary">ğŸ’¾ Simpan Permohonan</button>
     </div>
    </form>
   </div>
  </div><!-- Edit Modal -->
  <div id="edit-modal" class="modal-overlay" onclick="closeEditModal(event)">
   <div class="modal-content" onclick="event.stopPropagation()">
    <h2 style="font-size: 20px; font-weight: 800; color: #0b2a5b; margin: 0 0 24px 0;">âœï¸ Edit Permohonan</h2>
    <form id="edit-form" onsubmit="handleEditSubmit(event)">
     <div class="form-group"><label for="edit_student_name">Nama Pelajar *</label> <input type="text" id="edit_student_name" name="student_name" required placeholder="Masukkan nama pelajar">
     </div>
     <div class="form-group"><label for="edit_school_from">Sekolah Asal *</label> <select id="edit_school_from" name="school_from" required onchange="toggleCustomSchoolFromEdit()"> <option value="">-- Pilih Sekolah --</option> <option value="SMK Kota Marudu">SMK Kota Marudu</option> <option value="SMK Tandek">SMK Tandek</option> <option value="SMK Tandek 2">SMK Tandek 2</option> <option value="SMK Langkon">SMK Langkon</option> <option value="SMK Bengkongan">SMK Bengkongan</option> <option value="SMK Salaping">SMK Salaping</option> <option value="SMK Bandau">SMK Bandau</option> <option value="K9 Mangandai">K9 Mangandai</option> <option value="Sekolah Lain">Sekolah Lain</option> </select>
     </div>
     <div id="edit_custom_school_from_group" class="form-group" style="display: none;"><label for="edit_custom_school_from">Nama Sekolah Asal *</label> <input type="text" id="edit_custom_school_from" name="custom_school_from" placeholder="Masukkan nama sekolah">
     </div>
     <div class="form-group"><label for="edit_school_to">Sekolah Baharu *</label> <select id="edit_school_to" name="school_to" required onchange="toggleCustomSchoolToEdit()"> <option value="">-- Pilih Sekolah --</option> <option value="SMK Kota Marudu">SMK Kota Marudu</option> <option value="SMK Tandek">SMK Tandek</option> <option value="SMK Tandek 2">SMK Tandek 2</option> <option value="SMK Langkon">SMK Langkon</option> <option value="SMK Bengkongan">SMK Bengkongan</option> <option value="SMK Salaping">SMK Salaping</option> <option value="SMK Bandau">SMK Bandau</option> <option value="K9 Mangandai">K9 Mangandai</option> <option value="Sekolah Lain">Sekolah Lain</option> </select>
     </div>
     <div id="edit_custom_school_to_group" class="form-group" style="display: none;"><label for="edit_custom_school_to">Nama Sekolah Baharu *</label> <input type="text" id="edit_custom_school_to" name="custom_school_to" placeholder="Masukkan nama sekolah">
     </div>
     <div class="form-group"><label for="edit_grade">Tingkatan *</label> <select id="edit_grade" name="grade" required> <option value="">-- Pilih Tingkatan --</option> <option value="Tingkatan 1">Tingkatan 1</option> <option value="Tingkatan 2">Tingkatan 2</option> <option value="Tingkatan 3">Tingkatan 3</option> <option value="Tingkatan 4">Tingkatan 4</option> <option value="Tingkatan 5">Tingkatan 5</option> <option value="Tingkatan 6">Tingkatan 6</option> </select>
     </div>
     <div class="form-group"><label for="edit_transfer_category">Kategori Pertukaran *</label> <select id="edit_transfer_category" name="transfer_category" required> <option value="">-- Pilih Kategori --</option> <option value="Dalam Daerah">Dalam Daerah</option> <option value="Antara Daerah">Antara Daerah</option> <option value="Antara Negeri">Antara Negeri</option> <option value="Rayuan Khas">Rayuan Khas</option> <option value="Aliran/Program">Aliran/Program</option> <option value="Belajar Semula/Cicir">Belajar Semula/Cicir</option> <option value="Sekolah Swasta">Sekolah Swasta</option> <option value="Murid Bukan Warganegara">Murid Bukan Warganegara</option> <option value="Murid Warganegara Tanpa Dokumen">Murid Warganegara Tanpa Dokumen</option> </select>
     </div>
     <div class="form-group"><label for="edit_status">Status *</label> <select id="edit_status" name="status" required> <option value="">-- Pilih Status --</option> <option value="Dalam Proses">Dalam Proses</option> <option value="Diluluskan">Diluluskan</option> <option value="Ditolak">Ditolak</option> </select>
     </div>
     <div class="form-group"><label for="edit_date_applied">Tarikh Permohonan *</label> <input type="date" id="edit_date_applied" name="date_applied" required>
     </div>
<div class="form-group">
  <label for="edit_phone">No Telefon Ibu Bapa *</label>
  <input type="text" id="edit_phone" name="phone" placeholder="60123456789">
</div>
     <div class="form-group"><label for="edit_notes">Catatan</label> <textarea id="edit_notes" name="notes" placeholder="Masukkan catatan tambahan..."></textarea>
     </div>
     <div class="modal-actions"><button type="button" class="btn-secondary" onclick="closeEditModal()" style="flex: 1;">Batal</button> <button type="button" class="btn-secondary" onclick="deleteRecord()" style="flex: 1; background: #fecaca; color: #dc2626;">ğŸ—‘ï¸ Padam</button> <button type="submit" class="btn-primary" style="flex: 1;">ğŸ’¾ Simpan</button>
     </div>
    </form>
   </div>
  </div>
<!-- DETAIL MODAL -->
<div id="detail-modal" class="modal-overlay" onclick="closeDetailModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">

    <h2 style="font-size:20px;font-weight:800;color:#0b2a5b;margin:0 0 20px 0;">
      ğŸ“„ Detail Permohonan
    </h2>

    <div id="detail-content"></div>

    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeDetailModal()">Tutup</button>
    </div>

  </div>
</div>

<!-- Toast -->
  <div id="toast" class="toast-msg" style="background: #059669; color: #fff;"></div>
  <script>

  const SCHOOLS = [
    { name: 'SMK Kota Marudu', capacity: 1855, enrolled: 1647, analysis: 'Hampir maksimum' },
    { name: 'SMK Tandek', capacity: 1610, enrolled: 1454, analysis: 'Tinggi' },
    { name: 'SMK Tandek 2', capacity: 595, enrolled: 536, analysis: 'Tinggi' },
    { name: 'SMK Langkon', capacity: 840, enrolled: 691, analysis: 'Tinggi' },
    { name: 'SMK Bengkongan', capacity: 1155, enrolled: 888, analysis: 'Tinggi' },
    { name: 'SMK Salaping', capacity: 1785, enrolled: 1466, analysis: 'Tinggi' },
    { name: 'SMK Bandau', capacity: 1470, enrolled: 1064, analysis: 'Sederhana' },
    { name: 'K9 Mangandai', capacity: 105, enrolled: 50, analysis: 'Sederhana' },
  ];

  const MONTHS = ['Jan', 'Feb', 'Mac', 'Apr', 'Mei', 'Jun', 'Jul', 'Agt', 'Sep', 'Okt', 'Nov', 'Dis'];
const URL =
"https://script.google.com/macros/s/AKfycbxnMICR-6eHmpcdku39P3rBlKlhKAav0w3BZsGe71UCYU-wPEYFiM8zf4AhhIlEtMv8/exec";


  let allRecords = [];
let isLoadingSheet = false;

 
let charts = { donut: null, monthly: null, category: null, rankingCompare: null };

  let currentEditingId = null;
let currentRole = null;
const ADMIN_USERNAME = "adminppd";
const ADMIN_PASSWORD = "ppdkm2026";

function isAdmin() {
  return currentRole === "PPD";
}

// ===== ROLE PERMISSIONS =====
function applyRolePermissions() {

  const rankingTabBtn = document.querySelector('[data-tab="ranking"]');
  const capacityTabBtn = document.querySelector('[data-tab="capacity"]');
  const qa = getEl('quick-actions');

  // =========================
  // RESET DEFAULT (PPD MODE)
  // =========================
  if (qa) qa.style.display = "flex";

  if (rankingTabBtn) rankingTabBtn.style.display = "";
  if (capacityTabBtn) capacityTabBtn.style.display = "";

  document.querySelectorAll('nav .tab-btn').forEach(btn => {
  btn.style.display = "";
});


  // =========================
  // ROLE: PENGGUNA
  // =========================
  if (currentRole === "Pengguna") {

    // hide floating actions
    if (qa) qa.style.display = "none";

    // hide tab buttons
    
    // hide header buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
      const txt = btn.textContent;

      if (
        txt.includes("Excel") ||
        txt.includes("PDF") ||
        txt.includes("Tambah")
      ) {
        btn.style.display = "none";
      }
    });

    // â­ IMPORTANT:
    // kalau user sedang buka tab yang disembunyikan
    // paksa balik ke dashboard
    switchTab("dashboard");
  }
}
function logoutSystem() {

  localStorage.removeItem("role");
  localStorage.removeItem("username");

  currentRole = null;

  setText("user-display", "");

  getEl("login-modal")?.classList.add("show");

  applyRolePermissions();
  switchTab("dashboard");

  showToast("ğŸšª Anda telah log keluar", "#dc2626");
}
function showAdminLogin() {
  getEl("login-modal").classList.add("show");
}

function updateKPIs() {
  const total = allRecords.length;
  const approved = allRecords.filter(r => r.status === 'Diluluskan').length;
  const pending = allRecords.filter(r => r.status === 'Dalam Proses').length;
  const rejected = allRecords.filter(r => r.status === 'Ditolak').length;

  setText('kpi-total', total);
  setText('kpi-approved', approved);
  setText('kpi-pending', pending);
  setText('kpi-rejected', rejected); // â­ WAJIB
}
async function loadFromGoogleSheet() {

  if (isLoadingSheet) return;
  isLoadingSheet = true;

  try {

    // â­ bypass cache & CORS
    const res = await fetch(URL + "?t=" + Date.now());

    if (!res.ok) throw new Error("HTTP " + res.status);

    const text = await res.text();

    let data;
    try {
      data = JSON.parse(text);
    } catch {
      console.error("Response:", text);
      throw new Error("Response bukan JSON");
    }

    const rows = Array.isArray(data)
      ? data
      : (Array.isArray(data.data) ? data.data : []);

    allRecords = rows.map((r,i)=>({
  id: r.id,
  student_name: r.student_name,
  school_from: r.school_from,
  school_to: r.school_to,
  grade: r.grade,
  transfer_category: r.transfer_category,
  status: r.status,
  date_applied: r.date_applied,
  phone: r.phone || r.phone_number || "", // âœ… penting
  notes: r.notes || "",
  __backendId: String(r.id ?? i)
}));

    updateAllCharts();

    const live = getEl('live-status');
    if (live) live.textContent = 'â— LIVE';

  } catch(err) {

    console.error("LOAD ERROR:", err);

    const live = getEl('live-status');
    if (live) live.textContent = 'â— OFFLINE';

    showToast('âŒ Gagal load data: ' + err.message, '#dc2626');

  } finally {
    isLoadingSheet = false;
  }
}


  function getEl(id) { return document.getElementById(id); }
  function setText(id, text) { const el = getEl(id); if (el) el.textContent = text; }
  function setHTML(id, html) { const el = getEl(id); if (el) el.innerHTML = html; }

  function toggleCustomSchoolFrom() {
    const val = getEl('school_from').value;
    const customGroup = getEl('custom_school_from_group');
    const customInput = getEl('custom_school_from');
    if (val === 'Sekolah Lain') {
      customGroup.style.display = 'block';
      customInput.required = true;
    } else {
      customGroup.style.display = 'none';
      customInput.required = false;
      customInput.value = '';
    }
  }

  function toggleCustomSchoolTo() {
    const val = getEl('school_to').value;
    const customGroup = getEl('custom_school_to_group');
    const customInput = getEl('custom_school_to');
    if (val === 'Sekolah Lain') {
      customGroup.style.display = 'block';
      customInput.required = true;
    } else {
      customGroup.style.display = 'none';
      customInput.required = false;
      customInput.value = '';
    }
  }

  function toggleCustomSchoolFromEdit() {
    const val = getEl('edit_school_from').value;
    const customGroup = getEl('edit_custom_school_from_group');
    const customInput = getEl('edit_custom_school_from');
    if (val === 'Sekolah Lain') {
      customGroup.style.display = 'block';
      customInput.required = true;
    } else {
      customGroup.style.display = 'none';
      customInput.required = false;
      customInput.value = '';
    }
  }

  function toggleCustomSchoolToEdit() {
    const val = getEl('edit_school_to').value;
    const customGroup = getEl('edit_custom_school_to_group');
    const customInput = getEl('edit_custom_school_to');
    if (val === 'Sekolah Lain') {
      customGroup.style.display = 'block';
      customInput.required = true;
    } else {
      customGroup.style.display = 'none';
      customInput.required = false;
      customInput.value = '';
    }
  }

  const dataHandler = {
    onDataChanged(data) {
      if (!Array.isArray(data)) {
        console.warn('âš ï¸ Non-array data received');
        allRecords = [];
      } else {
        allRecords = data;
      }
      updateAllCharts();
    }
  };

  
// =====================
// START APP
// =====================
async function startApp() {

  console.log('ğŸš€ App started (Auto User Mode)');
  await loadFromGoogleSheet();

  const savedRole = localStorage.getItem('role');

  if (savedRole === "PPD") {
    currentRole = "PPD";
    getEl('login-modal')?.classList.remove('show');
    applyRolePermissions();

    setText(
      "user-display",
      "ğŸ‘¤ " + (localStorage.getItem("username") || "Admin")
    );

    return;
  }

  // default user
  currentRole = "Pengguna";
  getEl('login-modal')?.classList.remove('show');
  applyRolePermissions();

  setText("user-display", "ğŸ‘¤ Pengguna");
}


// =====================
// LOGIN SYSTEM
// =====================
function loginSystem() {

  const username = getEl("login-username").value.trim();
  const role = getEl("login-role").value;
  const password = getEl("admin-password").value;

  if (role === "PPD") {

    if (
      username !== ADMIN_USERNAME ||
      password !== ADMIN_PASSWORD
    ) {
      showToast("âŒ Username / password salah", "#dc2626");
      return;
    }
  }

  if (role === "Pengguna" && username === "") {
    showToast("âš ï¸ Masukkan nama pengguna", "#dc2626");
    return;
  }

  currentRole = role;
  localStorage.setItem("role", role);
  localStorage.setItem("username", username);

  setText("user-display", "ğŸ‘¤ " + username);

  getEl("login-modal").classList.remove("show");

  applyRolePermissions();

  showToast("âœ… Login berjaya", "#059669");
}


 
/* =========================
   EVENT LISTENER (SAFE)
========================= */
window.addEventListener('DOMContentLoaded', () => {

  const roleSelect = document.getElementById('login-role');

  if (roleSelect) {
    roleSelect.addEventListener('keypress', e => {
      if (e.key === 'Enter') loginSystem();
    });
  }

});

/* =========================
   START APP
========================= */
window.addEventListener('load', () => {

  startApp();

  // =========================
  // SMART GREETING AI ğŸ¤–
  // =========================
  setTimeout(() => {
    showToast(
      getGreeting() + ", selamat datang ke Dashboard PPD Kota Marudu ğŸ‘‹",
      "#0b2a5b"
    );
  }, 600); // tunggu UI siap render

  // =========================
  // AUTO REFRESH DATA
  // =========================
  setInterval(async () => {

  if (document.hidden) return;   // tab inactive

  if (getEl('add-modal')?.classList.contains('show')) return;
  if (getEl('edit-modal')?.classList.contains('show')) return;
  if (getEl('detail-modal')?.classList.contains('show')) return;

  await loadFromGoogleSheet();

}, 30000);


});


  function openAddModal() {

  if (!isAdmin()) {
    showToast("â›” Tiada kebenaran", "#dc2626");
    return;
  }

  getEl('add-modal').classList.add('show');
}

function closeAddModal(event) {
  if (event && event.target !== getEl('add-modal')) return;
  getEl('add-modal').classList.remove('show');
}


 // ===== GOOGLE SHEET API =====
async function saveToGoogleSheet(data) {
  try {
    const response = await fetch(URL, {
      method: "POST",
      headers: {
        "Content-Type": "text/plain;charset=utf-8"
      },
      body: JSON.stringify(data),
      redirect: "follow"
    });

    const text = await response.text();
    return JSON.parse(text);

  } catch (error) {
    console.error("Google Sheet Error:", error);
    return { result: "error" };
  }
}
function updateAllCharts() {
  updateKPIs();
  updateDonutChart();
  updateMonthlyChartJS();
  updateCategoryChart();
  updateCapacityCards();
  updateRanking();
  updateAIInsights();
  checkCriticalCapacity();
  renderList();
}


 async function handleAddSubmit(event) {
if (!isAdmin()) {
  showToast("â›” Tiada kebenaran", "#dc2626");
  return;
}

  event.preventDefault();

  let schoolFrom = getEl('school_from').value;
  let schoolTo = getEl('school_to').value;

  if (schoolFrom === 'Sekolah Lain') {
    schoolFrom = getEl('custom_school_from').value;
  }

  if (schoolTo === 'Sekolah Lain') {
    schoolTo = getEl('custom_school_to').value;
  }

  const newRecord = {
  student_name: getEl('student_name').value,
  school_from: schoolFrom,
  school_to: schoolTo,
  grade: getEl('grade').value,
  transfer_category: getEl('transfer_category').value,
  status: getEl('status').value,
  date_applied: getEl('date_applied').value,
  phone: formatPhone(getEl('phone').value), // âœ… TAMBAH INI
  notes: getEl('notes').value || ''
};
  const submitBtn = event.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'â³ Menyimpan...';

  try {

    const result = await saveToGoogleSheet(newRecord);
    console.log("RESPONSE GOOGLE:", result);

    if (result.result === "success") {

      showToast('âœ… Disimpan ke Google Sheet!', '#059669');

      closeAddModal();
      event.target.reset();

      // â­ PALING PENTING â€” refresh data dashboard
      await loadFromGoogleSheet();

    } else {
      showToast('âŒ Gagal simpan ke Google Sheet', '#dc2626');
    }

  } catch (err) {
    console.error(err);
    showToast('âŒ Ralat sistem', '#dc2626');
  }

  submitBtn.disabled = false;
  submitBtn.textContent = 'ğŸ’¾ Simpan Permohonan';
}



 function openEditModal(recordId) {

  // ğŸ” SECURITY CHECK
 if (!isAdmin()) {
    showToast("â›” Tiada kebenaran untuk edit", "#dc2626");
    return;
  }

  const record = allRecords.find(
    r => String(r.__backendId) === String(recordId)
  );

  if (!record) {
    showToast('âŒ Rekod tidak dijumpai', '#dc2626');
    return;
  }

    currentEditingId = recordId;
    getEl('edit_student_name').value = record.student_name || '';
    
    const schoolFromVal = record.school_from || '';
    const schoolToVal = record.school_to || '';

    const mainSchools = SCHOOLS.map(s => s.name);
    
    if (mainSchools.includes(schoolFromVal)) {
      getEl('edit_school_from').value = schoolFromVal;
      getEl('edit_custom_school_from_group').style.display = 'none';
    } else {
      getEl('edit_school_from').value = 'Sekolah Lain';
      getEl('edit_custom_school_from_group').style.display = 'block';
      getEl('edit_custom_school_from').value = schoolFromVal;
    }

    if (mainSchools.includes(schoolToVal)) {
      getEl('edit_school_to').value = schoolToVal;
      getEl('edit_custom_school_to_group').style.display = 'none';
    } else {
      getEl('edit_school_to').value = 'Sekolah Lain';
      getEl('edit_custom_school_to_group').style.display = 'block';
      getEl('edit_custom_school_to').value = schoolToVal;
    }

    getEl('edit_grade').value = record.grade || '';
    getEl('edit_transfer_category').value = record.transfer_category || '';
    getEl('edit_status').value = record.status || '';
    getEl('edit_date_applied').value = record.date_applied || '';
    getEl('edit_notes').value = record.notes || '';
    getEl('edit_phone').value = record.phone || '';
    getEl('edit-modal').classList.add('show');
  }
function sendWhatsApp(name, school, status, phone) {
console.log("PHONE:", phone);

  if (!phone) {
    showToast("âš ï¸ No telefon tiada", "#dc2626");
    return;
  }

  let message = "";

  if (status === "Diluluskan") {
    message = `Tuan/Puan, permohonan pertukaran bagi ${name} ke ${school} telah DILULUSKAN. Sila hadir ke PPD Kota Marudu untuk mengambil surat kelulusan.`;
  } 
  else if (status === "Dalam Proses") {
    message = `Tuan/Puan, permohonan pertukaran bagi ${name} masih dalam proses. Sebarang makluman akan dimaklumkan.`;
  } 
  else {
    message = `Tuan/Puan, permohonan pertukaran bagi ${name} tidak diluluskan. Sila hubungi pihak PPD untuk maklumat lanjut.`;
  }

 const url = `https://wa.me/${formatPhone(phone)}?text=${encodeURIComponent(message)}`;

  window.open(url, '_blank');
}
function formatPhone(phone){
  phone = phone.replace(/[^0-9]/g, '');

  if (phone.startsWith("0")) {
    phone = "6" + phone;
  }

  return phone;
}
  function closeEditModal(event) {
    if (event && event.target !== getEl('edit-modal')) return;
    getEl('edit-modal').classList.remove('show');
    currentEditingId = null;
  }

async function handleEditSubmit(event) {
  event.preventDefault();

  if (!isAdmin()) {
    showToast("â›” Tiada kebenaran", "#dc2626");
    return;
  }

  if (!currentEditingId) return;

  let schoolFrom = getEl('edit_school_from').value;
  let schoolTo = getEl('edit_school_to').value;

  if (schoolFrom === 'Sekolah Lain') {
    schoolFrom = getEl('edit_custom_school_from').value;
  }

  if (schoolTo === 'Sekolah Lain') {
    schoolTo = getEl('edit_custom_school_to').value;
  }

  const updatedRecord = {
    id: currentEditingId,
    action: "update",
    student_name: getEl('edit_student_name').value,
    school_from: schoolFrom,
    school_to: schoolTo,
    grade: getEl('edit_grade').value,
    transfer_category: getEl('edit_transfer_category').value,
    status: getEl('edit_status').value,
    date_applied: getEl('edit_date_applied').value,
    phone: formatPhone(getEl('edit_phone').value), // âœ… penting
    notes: getEl('edit_notes').value || ''
  };

  const result = await saveToGoogleSheet(updatedRecord);

  if (result.result === "success") {
    showToast('âœ… Rekod dikemaskini!', '#059669');
    closeEditModal();
    await loadFromGoogleSheet();
  } else {
    showToast('âŒ Gagal kemaskini', '#dc2626');
  }
}


 async function deleteRecord() {

  // ğŸ” SECURITY CHECK
 if (!isAdmin()) {
    showToast("â›” Tiada kebenaran", "#dc2626");
    return;
  }

  if (!currentEditingId) return;


  const confirmed = confirm("Padam permohonan ini?");
  if (!confirmed) return;

  const result = await saveToGoogleSheet({
    action: "delete",
    id: currentEditingId
  });

  if (result.result === "success") {
    showToast('âœ… Rekod dipadam', '#059669');
    closeEditModal();
    await loadFromGoogleSheet();
  } else {
    showToast('âŒ Gagal padam', '#dc2626');
  }
}


 function updateAIInsights() {

  const container = getEl('ai-insights');
  if (!container) return;

  if (allRecords.length === 0) {
    container.innerHTML = `
      <div style="padding:12px;background:#f8fafc;border-radius:10px;">
        Tiada data untuk analisis.
      </div>`;
    return;
  }

  // =========================
  // DATA ASAS
  // =========================
  const approved = allRecords.filter(r => r.status === 'Diluluskan');
  const approvalRate =
    Math.round((approved.length / allRecords.length) * 100);

  // kategori paling tinggi
  const categoryCount = {};
  allRecords.forEach(r => {
    if (!r.transfer_category) return;
    categoryCount[r.transfer_category] =
      (categoryCount[r.transfer_category] || 0) + 1;
  });

  const topCategory = Object.entries(categoryCount)
    .sort((a,b)=>b[1]-a[1])[0];

  // trend bulan semasa
  const monthNow = new Date().getMonth();
  const thisMonth = allRecords.filter(r => {
    if (!r.date_applied) return false;
    return new Date(r.date_applied).getMonth() === monthNow;
  }).length;

  // =========================
  // START HTML (PENTING)
  // =========================
  let html = `
    <div style="padding:10px;background:#eef2ff;border-radius:8px;font-size:12px;font-weight:600;">
      ğŸ“Š Kadar kelulusan: ${approvalRate}%
    </div>

    <div style="padding:10px;background:#fef9c3;border-radius:8px;font-size:12px;font-weight:600;">
      ğŸ† Kategori tertinggi: ${topCategory ? topCategory[0] : '-'}
    </div>

    <div style="padding:10px;background:#ecfeff;border-radius:8px;font-size:12px;font-weight:600;">
      ğŸ“… Permohonan bulan ini: ${thisMonth}
    </div>
  `;

  // =========================
  // AUTO RECOMMENDATION
  // =========================
  const highPressureSchools = SCHOOLS.filter(s =>
    getSchoolCapacityPct(s.name) >= 85
  );

  if (highPressureSchools.length > 0) {

    html += `
      <div style="
        margin-top:10px;
        padding:10px;
        background:#fee2e2;
        border-radius:8px;
        font-size:12px;
        font-weight:700;">
        ğŸ¤– Cadangan Sekolah Alternatif
      </div>
    `;

    highPressureSchools.forEach(s => {

      const alternatives = getAlternativeSchools(s.name);

      html += `
        <div style="
          background:#f8fafc;
          padding:10px;
          border-left:4px solid #dc2626;
          margin-top:6px;
          font-size:12px;">
          âš ï¸ ${s.name} hampir penuh.<br>
          Cadangan:
          <b>${alternatives
            .map(a => `${a.name} (${a.pct}%)`)
            .join(', ')}</b>
        </div>
      `;
    });
  }

  // =========================
  // PAPAR
  // =========================
  container.innerHTML = html;
}

  function updateDonutChart() {
    const approved = allRecords.filter(r => r.status === 'Diluluskan').length;
    const pending = allRecords.filter(r => r.status === 'Dalam Proses').length;
    const rejected = allRecords.filter(r => r.status === 'Ditolak').length;

    const canvas = getEl('donut-chart');
    if (!canvas) return;

    if (charts.donut) charts.donut.destroy();

    charts.donut = new Chart(canvas, {
      type: 'doughnut',
      data: {
        labels: ['Diluluskan', 'Dalam Proses', 'Ditolak'],
        datasets: [{
          data: [approved, pending, rejected],
          backgroundColor: ['#059669', '#d97706', '#dc2626'],
          borderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { font: { size: 12, weight: '600' }, padding: 15 } }
        }
      }
    });
  }

  function updateMonthlyChartJS() {
    const monthlyCount = Array(12).fill(0);
    allRecords.forEach(r => {
      if (r.date_applied) {
        const date = new Date(r.date_applied);
        const month = date.getMonth();
        monthlyCount[month]++;
      }
    });

    const canvas = getEl('monthly-chart');
    if (!canvas) return;

    if (charts.monthly) charts.monthly.destroy();

    const colors = ['#0b2a5b', '#1e4fa3', '#2d5fa8', '#0b5a9e', '#1472c4', '#3b82f6', '#0ea5e9', '#06b6d4', '#10b981', '#059669', '#d97706', '#dc2626'];

    charts.monthly = new Chart(canvas, {
      type: 'bar',
      data: {
        labels: MONTHS,
        datasets: [{
          label: 'Permohonan',
          data: monthlyCount,
          backgroundColor: colors,
          borderRadius: 8,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1 } }
        }
      }
    });
  }

  function updateCategoryChart() {
    const categoryCounts = {};
    allRecords.forEach(r => {
      if (r.transfer_category) {
        categoryCounts[r.transfer_category] = (categoryCounts[r.transfer_category] || 0) + 1;
      }
    });

    const canvas = getEl('category-chart');
    if (!canvas) return;

    if (charts.category) charts.category.destroy();

    const labels = Object.keys(categoryCounts);
    const data = Object.values(categoryCounts);
    
    const categoryColors = {
      'Dalam Daerah': '#0b2a5b',
      'Antara Daerah': '#1e4fa3',
      'Antara Negeri': '#2d5fa8',
      'Rayuan Khas': '#f59e0b',
      'Aliran/Program': '#10b981',
      'Belajar Semula/Cicir': '#8b5cf6',
      'Sekolah Swasta': '#ec4899',
      'Murid Bukan Warganegara': '#06b6d4',
      'Murid Warganegara Tanpa Dokumen': '#f97316'
    };

    const colors = labels.map(label => categoryColors[label] || '#64748b');

    charts.category = new Chart(canvas, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Bilangan Permohonan',
          data: data,
          backgroundColor: colors,
          borderRadius: 8,
          borderSkipped: false
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { beginAtZero: true, ticks: { stepSize: 1 } }
        }
      }
    });
  }

  function updateCapacityCards() {

  const transfersTo = {};

  allRecords
    .filter(r => r.status === 'Diluluskan')
    .forEach(r => {
      if (r.school_to) {
        transfersTo[r.school_to] =
          (transfersTo[r.school_to] || 0) + 1;
      }
    });

  let html = '';

  SCHOOLS.forEach(school => {

    const extra = transfersTo[school.name] || 0;
    const current = school.enrolled + extra;
    const pct = Math.round((current / school.capacity) * 100);

    // ğŸ¨ WARNA HEATMAP
    let heatColor = '#dcfce7';   // hijau
    let borderColor = '#22c55e';
    let label = 'RENDAH';

    if (pct >= 95) {
      heatColor = '#fee2e2';     // merah
      borderColor = '#dc2626';
      label = 'KRITIKAL';
    } else if (pct >= 85) {
      heatColor = '#ffedd5';     // oren
      borderColor = '#f97316';
      label = 'TINGGI';
    } else if (pct >= 75) {
      heatColor = '#fef9c3';     // kuning
      borderColor = '#eab308';
      label = 'SEDERHANA';
    }

    html += `
      <div class="capacity-card heat-card"
           style="background:${heatColor};border-color:${borderColor};">

        <div style="display:flex;justify-content:space-between;align-items:start;">
          <div>
            <p style="font-size:14px;font-weight:700;margin:0;">
              ${school.name}
            </p>
            <p style="font-size:11px;margin-top:4px;color:#475569;">
              ${label}
            </p>
          </div>

          <div style="
            font-size:20px;
            font-weight:800;
            color:${borderColor};">
            ${pct}%
          </div>
        </div>

        <div class="capacity-bar">
          <div class="capacity-fill"
               style="width:${Math.min(pct,100)}%;
               background:${borderColor};">
          </div>
        </div>

        <div style="
          display:flex;
          justify-content:space-between;
          font-size:11px;
          color:#475569;
          margin-top:6px;">
          <span>${current} pelajar</span>
          <span>Kapasiti ${school.capacity}</span>
        </div>

      </div>
    `;
  });

  setHTML('capacity-container', html);
}

function getSchoolCapacityPct(schoolName) {

  const school = SCHOOLS.find(s => s.name === schoolName);
  if (!school) return 0;

  const extra = allRecords.filter(r =>
    r.status === 'Diluluskan' &&
    r.school_to === schoolName
  ).length;

  return Math.round(((school.enrolled + extra) / school.capacity) * 100);
}
function getAlternativeSchools(currentSchool) {

  return SCHOOLS
    .filter(s => s.name !== currentSchool)
    .map(s => ({
      name: s.name,
      pct: getSchoolCapacityPct(s.name)
    }))
    .sort((a,b) => a.pct - b.pct) // paling kosong atas
    .slice(0,3); // TOP 3
}

  function checkCriticalCapacity() {
    const transfersTo = {};
    allRecords.filter(r => r.status === 'Diluluskan').forEach(r => {
      if (r.school_to) transfersTo[r.school_to] = (transfersTo[r.school_to] || 0) + 1;
    });

    const critical = [];
    SCHOOLS.forEach(s => {
      const extra = transfersTo[s.name] || 0;
      const current = s.enrolled + extra;
      const pct = Math.round((current / s.capacity) * 100);
      if (pct > 90) critical.push({ name: s.name, pct, current, capacity: s.capacity });
    });

    let html = '';
    critical.forEach(item => {
      html += `<div class="critical-alert">
        <p>âš ï¸ KAPASITI KRITIKAL: ${item.name} mencapai ${item.pct}% (${item.current}/${item.capacity})</p>
      </div>`;
    });

    getEl('critical-alerts').innerHTML = html;
  }

  function handleSearch() {
    const query = getEl('search-input').value.trim().toLowerCase();
    const results = getEl('search-results');

    if (query.length < 2) {
      results.classList.remove('show');
      return;
    }

    const filtered = allRecords.filter(r => r.student_name && r.student_name.toLowerCase().includes(query)).slice(0, 8);

    if (filtered.length === 0) {
      results.innerHTML = '<div style="padding: 10px 14px; color: #94a3b8; font-size: 12px;">Tiada hasil</div>';
      results.classList.add('show');
      return;
    }

    let html = '';
    filtered.forEach(record => {
      const statusColor = { 'Diluluskan': '#059669', 'Dalam Proses': '#d97706', 'Ditolak': '#dc2626' };
      const c = statusColor[record.status] || '#94a3b8';
      html += `<div class="search-result-item" onclick="openDetailModal('${record.__backendId}')">

        <div style="font-weight: 600;">${record.student_name}</div>
        <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">
          ${record.school_from} â†’ ${record.school_to} | <span style="color: ${c}; font-weight: 600;">${record.status}</span>
        </div>
      </div>`;
    });

    results.innerHTML = html;
    results.classList.add('show');
  }

  function searchSelectRecord(id) {
  getEl('search-results').classList.remove('show');
  getEl('search-input').value = '';

  switchTab('senarai');
  renderList();

  setTimeout(() => {
    const row = document.querySelector(`[data-id="${id}"]`);
    if (row) row.scrollIntoView({behavior:'smooth'});
  }, 200);
}

  function renderList() {

  const container = getEl('list-container');
  const emptyMsg = getEl('list-empty');
  if (!container || !emptyMsg) return;

  const filterVal = getEl('list-filter-status')?.value || 'all';
  const filtered =
    filterVal === 'all'
      ? allRecords
      : allRecords.filter(r => r.status === filterVal);

  if (filtered.length === 0) {
    container.innerHTML = '';
    emptyMsg.style.display = 'block';
    return;
  }

  emptyMsg.style.display = 'none';

  const statusColor = {
    'Diluluskan': '#059669',
    'Dalam Proses': '#d97706',
    'Ditolak': '#dc2626'
  };

  let html = `
    <table class="rank-table">
      <thead>
        <tr>
          <th>Nama</th>
          <th>Asal</th>
          <th>Baharu</th>
          <th>Tingkatan</th>
          <th>Kategori</th>
          <th>Tarikh</th>
          <th>Status</th>
          <th style="text-align:center;">Tindakan</th>
        </tr>
      </thead>
      <tbody>
  `;

  filtered.forEach(r => {

    // âœ… ID selamat
    const rowId = String(r.__backendId || r.id || '');

    const c = statusColor[r.status] || '#94a3b8';
    const dateStr = r.date_applied
      ? new Date(r.date_applied).toLocaleDateString('ms-MY')
      : '-';

    html += `
<tr data-id="${rowId}">
  <td>${r.student_name || '-'}</td>
  <td>${r.school_from || '-'}</td>
  <td>${r.school_to || '-'}</td>
  <td>${r.grade || '-'}</td>
  <td>${r.transfer_category || '-'}</td>
  <td>${dateStr}</td>

  <td>
    <span style="
      background:${c}15;
      color:${c};
      padding:4px 8px;
      border-radius:6px;
      font-size:10px;
      font-weight:700;">
      ${r.status}
    </span>
  </td>

  <td style="text-align:center;">
  ${
    isAdmin()
      ? `
        <button onclick="openEditModal('${rowId}')" class="edit-btn">
          âœï¸ Edit
        </button>

        <button onclick="sendWhatsApp('${r.student_name}', '${r.school_to}', '${r.status}', '${r.phone || ""}')"
          style="
            background:#25D366;
            color:#fff;
            border:none;
            padding:6px 10px;
            border-radius:6px;
            font-size:11px;
            font-weight:700;
            cursor:pointer;
            margin-left:6px;">
          ğŸ’¬ WhatsApp
        </button>
      `
      : `<span style="font-size:11px;color:#94a3b8;font-weight:600;">ğŸ‘ï¸ View</span>`
  }
</td>
</tr>
`;

  });

  html += `
      </tbody>
    </table>
  `;

  container.innerHTML = html;
}


 function updateRanking() {
  const approved = allRecords.filter(r => r.status === 'Diluluskan');
  const outgoing = {};
  const incoming = {};
  const schoolNames = SCHOOLS.map(s => s.name);

  approved.forEach(r => {

    // =========================
    // KIRA KELUAR (Jika tuan mahu tapis cicir sekolah sama, kekalkan ini)
    // =========================
    if (r.school_from && schoolNames.includes(r.school_from)) {
      if (
        r.transfer_category === "Belajar Semula/Cicir" &&
        r.school_from === r.school_to
      ) {
        // skip keluar sahaja
      } else {
        outgoing[r.school_from] = (outgoing[r.school_from] || 0) + 1;
      }
    }

    // =========================
    // KIRA MASUK (ASAL)
    // =========================
    if (r.school_to && schoolNames.includes(r.school_to)) {
      incoming[r.school_to] = (incoming[r.school_to] || 0) + 1;
    }
  });

  // Top 5 jadual (asal)
  const sortedOut = Object.entries(outgoing).sort((a, b) => b[1] - a[1]).slice(0, 5);
  const sortedIn  = Object.entries(incoming).sort((a, b) => b[1] - a[1]).slice(0, 5);

  // =========================
  // âœ… DATA UNTUK GRAF (Top 8 gabungan)
  // =========================
  const topN = 8;

  const topOutSchools = Object.entries(outgoing)
    .sort((a,b)=>b[1]-a[1])
    .slice(0, topN)
    .map(x => x[0]);

  const topInSchools = Object.entries(incoming)
    .sort((a,b)=>b[1]-a[1])
    .slice(0, topN)
    .map(x => x[0]);

  const labels = Array.from(new Set([...topOutSchools, ...topInSchools])).slice(0, topN);

  const outData = labels.map(s => outgoing[s] || 0);
  const inData  = labels.map(s => incoming[s] || 0);

  renderRankingCompareChart(labels, outData, inData);

  // =========================
  // JADUAL ASAL (kekal)
  // =========================
  let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">';

  html += '<div><h3 style="font-size: 13px; font-weight: 700; color: #0b2a5b; margin: 0 0 12px 0;">ğŸ“¤ Bilangan Keluar</h3>';
  html += '<table class="rank-table"><thead><tr><th>No.</th><th>Sekolah</th><th>Keluar</th></tr></thead><tbody>';
  sortedOut.forEach((entry, idx) => {
    html += `<tr><td>${idx + 1}</td><td style="font-size: 12px; font-weight: 600;">${entry[0]}</td><td style="font-weight: 700; color: #dc2626; text-align: right;">${entry[1]}</td></tr>`;
  });
  html += '</tbody></table></div>';

  html += '<div><h3 style="font-size: 13px; font-weight: 700; color: #0b2a5b; margin: 0 0 12px 0;">ğŸ“¥ Bilangan Masuk</h3>';
  html += '<table class="rank-table"><thead><tr><th>No.</th><th>Sekolah</th><th>Masuk</th></tr></thead><tbody>';
  sortedIn.forEach((entry, idx) => {
    html += `<tr><td>${idx + 1}</td><td style="font-size: 12px; font-weight: 600;">${entry[0]}</td><td style="font-weight: 700; color: #059669; text-align: right;">${entry[1]}</td></tr>`;
  });
  html += '</tbody></table></div>';

  html += '</div>';

  getEl('ranking-container').innerHTML =
    (sortedOut.length > 0 || sortedIn.length > 0)
      ? html
      : '<p style="color: #94a3b8; text-align: center; padding: 40px;">Tiada data</p>';
}
function renderRankingCompareChart(labels, outData, inData) {
  const canvas = getEl('ranking-compare-chart');
  if (!canvas) return;

  if (charts.rankingCompare) charts.rankingCompare.destroy();

  charts.rankingCompare = new Chart(canvas, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Keluar',
          data: outData,
          backgroundColor: '#dc2626',
          borderRadius: 8,
          borderSkipped: false
        },
        {
          label: 'Masuk',
          data: inData,
          backgroundColor: '#059669',
          borderRadius: 8,
          borderSkipped: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' }
      },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      }
    }
  });
}

 function exportPDFKPM() {

  if (typeof html2pdf === "undefined") {
    showToast("âŒ Library PDF belum load", "#dc2626");
    return;
  }

  if (!allRecords || allRecords.length === 0) {
    showToast("âŒ Tiada data", "#dc2626");
    return;
  }

  const safeDate = new Date().toISOString().slice(0,10);

  // =========================
  // KPI
  // =========================
  const total = allRecords.length;
  const approved = allRecords.filter(r=>r.status==="Diluluskan").length;
  const pending = allRecords.filter(r=>r.status==="Dalam Proses").length;
  const rejected = allRecords.filter(r=>r.status==="Ditolak").length;

  // =========================
  // KATEGORI
  // =========================
  const categoryCount = {};
  allRecords.forEach(r=>{
    if(!r.transfer_category) return;
    categoryCount[r.transfer_category] =
      (categoryCount[r.transfer_category] || 0) + 1;
  });

  // =========================
  // BULAN
  // =========================
  const monthlyCount = Array(12).fill(0);

  allRecords.forEach(r=>{
    if(r.date_applied){
      const m = new Date(r.date_applied).getMonth();
      monthlyCount[m]++;
    }
  });

  // =========================
  // HTML REPORT
  // =========================
  const temp = document.createElement("div");
  temp.style.padding = "28px";
  temp.style.fontFamily = "Arial";
  temp.style.fontSize = "12px";
  temp.style.color = "#111";

 temp.innerHTML = `
  
  <!-- HEADER RASMI -->
  <div style="text-align:center; margin-bottom:20px;">

    <img src="https://i.imgur.com/4EGUuTx.png"
         style="
           width:80px;
           height:80px;
           object-fit:contain;
           display:block;
           margin:0 auto 10px auto;
         ">

    <h2 style="
      margin:0;
      font-size:20px;
      font-weight:800;
      color:#0b2a5b;
      letter-spacing:0.5px;">
      LAPORAN BULANAN PERTUKARAN MURID
    </h2>

    <p style="
      margin-top:4px;
      font-size:12px;
      color:#475569;">
      Pejabat Pendidikan Daerah Kota Marudu
    </p>

  </div>

    <hr style="margin:14px 0;">

    <h3 style="margin-bottom:6px;">1. Ringkasan Statistik</h3>
    <table style="width:100%;border-collapse:collapse;">
      <tr>
        <td style="border:1px solid #ccc;padding:6px;">Jumlah Permohonan</td>
        <td style="border:1px solid #ccc;padding:6px;"><b>${total}</b></td>
      </tr>
      <tr>
        <td style="border:1px solid #ccc;padding:6px;">Diluluskan</td>
        <td style="border:1px solid #ccc;padding:6px;color:#059669;"><b>${approved}</b></td>
      </tr>
      <tr>
        <td style="border:1px solid #ccc;padding:6px;">Dalam Proses</td>
        <td style="border:1px solid #ccc;padding:6px;color:#d97706;"><b>${pending}</b></td>
      </tr>
      <tr>
        <td style="border:1px solid #ccc;padding:6px;">Ditolak</td>
        <td style="border:1px solid #ccc;padding:6px;color:#dc2626;"><b>${rejected}</b></td>
      </tr>
    </table>

    <h3 style="margin-top:18px;">2. Statistik Mengikut Kategori</h3>
    <table style="width:100%;border-collapse:collapse;">
      <tr style="background:#f1f5f9;">
        <th style="border:1px solid #ccc;padding:6px;text-align:left;">Kategori</th>
        <th style="border:1px solid #ccc;padding:6px;">Bilangan</th>
      </tr>
      ${Object.entries(categoryCount).map(c => `
        <tr>
          <td style="border:1px solid #ccc;padding:6px;">${c[0]}</td>
          <td style="border:1px solid #ccc;padding:6px;text-align:center;">${c[1]}</td>
        </tr>
      `).join('')}
    </table>

    <h3 style="margin-top:18px;">3. Statistik Mengikut Bulan</h3>
    <table style="width:100%;border-collapse:collapse;">
      <tr style="background:#f1f5f9;">
        <th style="border:1px solid #ccc;padding:6px;">Bulan</th>
        <th style="border:1px solid #ccc;padding:6px;">Bilangan</th>
      </tr>
      ${MONTHS.map((m,i)=>`
        <tr>
          <td style="border:1px solid #ccc;padding:6px;">${m}</td>
          <td style="border:1px solid #ccc;padding:6px;text-align:center;">
            ${monthlyCount[i]}
          </td>
        </tr>
      `).join('')}
    </table>

    <br><br><br>

    <table style="width:100%;margin-top:30px;">
      <tr>
        <td style="width:50%;text-align:center;">
          ______________________________<br>
          Penolong Pegawai Pendidikan Daerah<br>
          PPD Kota Marudu
        </td>

        <td style="width:50%;text-align:center;">
          ______________________________<br>
          Timbalan Sektor Pengurusan Sekolah<br>
          PPD Kota Marudu
        </td>
      </tr>
    </table>

    <p style="font-size:10px;color:#666;margin-top:30px;">
      Dijana automatik oleh Dashboard Enterprise PPD Kota Marudu
    </p>
  `;

  document.body.appendChild(temp);

  html2pdf()
    .from(temp)
    .set({
      margin: 10,
      filename: `Laporan_Bulanan_Pertukaran_${safeDate}.pdf`,
      html2canvas: { scale: 2 },
      jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
    })
    .save()
    .then(() => {
      document.body.removeChild(temp);
      showToast("âœ… Laporan bulanan PDF berjaya dijana", "#059669");
    });
}

  function switchTab(tab) {
    document.querySelectorAll('[role="tabpanel"]').forEach(p => p.style.display = 'none');
    const tabEl = getEl('tab-' + tab);
    if (tabEl) tabEl.style.display = 'block';

    document.querySelectorAll('[data-tab]').forEach(btn => {
      const isActive = btn.dataset.tab === tab;
      btn.classList.toggle('active', isActive);
      btn.style.background = isActive ? 'linear-gradient(135deg, #0b2a5b, #1e4fa3)' : 'transparent';
      btn.style.color = isActive ? '#fff' : '#64748b';
    });
  }

  function showToast(msg, color) {
    const toast = getEl('toast');
    if (!toast) return;
    toast.textContent = msg;
    toast.style.background = color || '#059669';
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }

  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const btn = getEl('dark-mode-toggle');
    if (btn) btn.textContent = document.body.classList.contains('dark-mode') ? 'â˜€ï¸' : 'ğŸŒ™';
  }

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-box')) {
      getEl('search-results').classList.remove('show');
    }
  });

function cancelLogin() {

  // kosongkan input
  getEl("login-username").value = "";
  getEl("admin-password").value = "";

  // tutup modal
  getEl("login-modal").classList.remove("show");

  // terus masuk sebagai pengguna biasa
  currentRole = "Pengguna";
  applyRolePermissions();

  setText("user-display", "ğŸ‘¤ Pengguna");

  showToast("â„¹ï¸ Masuk sebagai pengguna biasa", "#64748b");
}
// =========================
// SMART GREETING AI
// =========================
function getGreeting() {

  const h = new Date().getHours();

  if (h < 12) return "â˜€ï¸ Selamat pagi";
  if (h < 18) return "ğŸŒ¤ï¸ Selamat petang";
  return "ğŸŒ™ Selamat malam";
}
function openDetailModal(recordId){

  const record = allRecords.find(
    r => String(r.__backendId) === String(recordId)
  );

  if(!record){
    showToast("âŒ Rekod tidak dijumpai", "#dc2626");
    return;
  }

  const html = `
    <div style="display:grid;gap:10px;font-size:13px;">
      <div><b>Nama Pelajar:</b> ${record.student_name || '-'}</div>
      <div><b>Sekolah Asal:</b> ${record.school_from || '-'}</div>
      <div><b>Sekolah Baharu:</b> ${record.school_to || '-'}</div>
      <div><b>Tingkatan:</b> ${record.grade || '-'}</div>
      <div><b>Kategori:</b> ${record.transfer_category || '-'}</div>
      <div><b>Status:</b> ${record.status || '-'}</div>
      <div><b>Tarikh:</b> ${
        record.date_applied
          ? new Date(record.date_applied).toLocaleDateString('ms-MY')
          : '-'
      }</div>
      <div><b>Catatan:</b><br>${record.notes || '-'}</div>
    </div>
  `;

  setHTML("detail-content", html);

  getEl("detail-modal").classList.add("show");
}
function closeDetailModal(event){
  if(event && event.target !== getEl("detail-modal")) return;
  getEl("detail-modal").classList.remove("show");
}
function sendWhatsApp(name, school, status) {

  // ğŸ‘‰ nombor ibu bapa (boleh tambah dalam database nanti)
  const phone = "60123456789"; // format Malaysia tanpa +

  let message = "";

  if (status === "Diluluskan") {
    message = `Tuan/Puan, permohonan pertukaran bagi ${name} ke ${school} telah DILULUSKAN. Sila hadir ke PPD Kota Marudu untuk mengambil surat kelulusan.`;
  } 
  else if (status === "Dalam Proses") {
    message = `Tuan/Puan, permohonan pertukaran bagi ${name} masih dalam proses. Sebarang makluman akan dimaklumkan dari semasa ke semasa.`;
  } 
  else {
    message = `Tuan/Puan, permohonan pertukaran bagi ${name} tidak diluluskan. Sila hubungi pihak PPD untuk maklumat lanjut.`;
  }

  const url = `https://wa.me/${formatPhone(phone)}?text=${encodeURIComponent(message)}`;

  window.open(url, '_blank');
}
</script>
<script>(function(){function c(){ ... cdn-cgi/challenge-platform ... }}</script>
<!-- LOGIN MODAL -->
<div id="login-modal" class="modal-overlay show">
  <div class="modal-content" style="max-width:400px;">

    <h2 style="font-size:20px;font-weight:800;margin-bottom:20px;">
      ğŸ” Login Dashboard
    </h2>

    <!-- USERNAME -->
    <div class="form-group">
      <label>Username</label>
      <input type="text"
             id="login-username"
             placeholder="Masukkan username">
    </div>

    <!-- ROLE -->
    <div class="form-group">
      <label>Pilih Peranan</label>
      <select id="login-role">
        <option value="PPD">ğŸ§‘â€ğŸ’¼ PPD (Admin)</option>
        <option value="Pengguna">ğŸ‘¤ Pengguna</option>
      </select>
    </div>

    <!-- PASSWORD -->
    <div class="form-group">
      <label>Password Admin (PPD)</label>
      <input type="password"
             id="admin-password"
             placeholder="Masukkan password admin">
    </div>

   <div class="modal-actions" style="margin-top:18px; display:flex; gap:10px;">
  
  <button type="button"
          class="btn-secondary"
          style="flex:1;"
          onclick="cancelLogin()">
    Batal
  </button>

  <button type="button"
          class="btn-primary"
          style="flex:1;"
          onclick="loginSystem()">
    Masuk Dashboard
  </button>

</div>


  </div>
</div>
<script>
if (typeof html2pdf === "undefined") {
  const s = document.createElement("script");
  s.src = "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js";
  document.body.appendChild(s);
}
</script>

</body>
</html>
